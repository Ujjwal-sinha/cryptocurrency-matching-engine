<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cryptocurrency Matching Engine - Architecture</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 30px;
            border-left: 4px solid #4CAF50;
            padding-left: 10px;
        }
        .diagram {
            background: #fafafa;
            padding: 20px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .mermaid {
            display: flex;
            justify-content: center;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .complexity {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .note {
            background: #fff3cd;
            padding: 15px;
            border-left: 4px solid #ffc107;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”§ Cryptocurrency Matching Engine - System Architecture</h1>
        <p>Built for GoQuant - Implementing REG NMS Principles</p>

        <h2>1. High-Level System Architecture</h2>
        <div class="diagram">
            <div class="mermaid">
            graph TB
                subgraph "Client Layer"
                    REST[REST API Clients]
                    WS[WebSocket Subscribers]
                end
                
                subgraph "API Layer"
                    FLASK[Flask REST API]
                    WEBSOCKET[WebSocket Server]
                end
                
                subgraph "Core Engine"
                    ME[MatchingEngine]
                    OB1[OrderBook BTC-USDT]
                    OB2[OrderBook ETH-USDT]
                end
                
                subgraph "Data Structures"
                    HEAP[Price Heaps]
                    DEQUE[Deque FIFO]
                    DICT[Order Dictionary]
                end
                
                REST --> FLASK
                WS --> WEBSOCKET
                FLASK --> ME
                WEBSOCKET --> ME
                ME --> OB1
                ME --> OB2
                OB1 --> HEAP
                OB1 --> DEQUE
                OB1 --> DICT
                OB2 --> HEAP
                OB2 --> DEQUE
                OB2 --> DICT
            </div>
        </div>

        <h2>2. Order Processing Flow</h2>
        <div class="diagram">
            <div class="mermaid">
            sequenceDiagram
                participant Client
                participant REST API
                participant MatchingEngine
                participant OrderBook
                participant Callbacks
                
                Client->>REST API: POST /orders
                REST API->>MatchingEngine: submit_order()
                
                MatchingEngine->>MatchingEngine: validate_order()
                MatchingEngine->>OrderBook: add_order()
                
                OrderBook->>OrderBook: _match_buy_order()
                OrderBook->>OrderBook: Heap heappop(best_price)
                OrderBook->>OrderBook: Deque popleft(FIFO)
                OrderBook-->>MatchingEngine: List[Trade]
                
                MatchingEngine->>Callbacks: _notify_trades()
                MatchingEngine->>Callbacks: _notify_market_data()
                
                MatchingEngine-->>REST API: Order + Trades
                REST API-->>Client: JSON Response
            </div>
        </div>

        <h2>3. Order Book Data Structure</h2>
        <div class="diagram">
            <div class="mermaid">
            graph LR
                subgraph "OrderBook"
                    BIDS[Bids Dict]
                    ASKS[Asks Dict]
                    BH[Bid Heaps]
                    AH[Ask Heaps]
                    ORD[Order Dict]
                end
                
                subgraph "PriceLevel"
                    PL[PriceLevel $51,000]
                    DEQ[Deque Orders]
                    Q1[Order #1]
                    Q2[Order #2]
                    Q3[Order #3]
                end
                
                BIDS --> PL
                ASKS --> PL
                BH --> |"heapq heappop()"| PL
                AH --> |"heapq heappush()"| PL
                PL --> DEQ
                DEQ --> Q1
                Q1 --> Q2
                Q2 --> Q3
            </div>
        </div>

        <h2>4. Matching Algorithm Flow</h2>
        <div class="diagram">
            <div class="mermaid">
            flowchart TD
                A[Order Arrives] --> B{Marketable?}
                B -->|Yes| C[Find Best Price]
                B -->|No| D[Rest on Book]
                
                C --> E[heapq heappop]
                E --> F[Get PriceLevel]
                F --> G[Get First Order in Deque]
                G --> H[Create Trade]
                H --> I{Remaining Quantity?}
                
                I -->|Yes| J[Move to Next Order]
                J --> G
                I -->|No| K[Update BBO]
                
                D --> L[Add to Deque]
                K --> M[Notify Callbacks]
                L --> M
                
                style A fill:#e1f5ff
                style H fill:#c8e6c9
                style M fill:#fff3cd
            </div>
        </div>

        <h2>5. Order Types Processing</h2>
        <div class="diagram">
            <div class="mermaid">
            stateDiagram-v2
                [*] --> Validate: Order Received
                Validate --> Market: Market Order
                Validate --> Limit: Limit Order
                Validate --> IOC: IOC Order
                Validate --> FOK: FOK Order
                
                Market --> Match: Execute
                Limit --> Match: Match if possible
                Limit --> Rest: Add to book
                
                IOC --> Match: Execute
                IOC --> Cancel: Reject unfilled
                
                FOK --> CheckFill: Check full fill
                CheckFill --> Match: Can fill
                CheckFill --> Reject: Cannot fill
                
                Match --> Notify: Create trades
                Rest --> Notify: Update book
                Cancel --> [*]
                Reject --> [*]
                Notify --> [*]
            </div>
        </div>

        <h2>6. Memory Layout</h2>
        <div class="diagram">
            <div class="mermaid">
            graph TB
                OB[OrderBook Object]
                OB --> BID_DICT["bids: Dict Price to PriceLevel"]
                OB --> ASK_DICT["asks: Dict Price to PriceLevel"]
                OB --> HEAP_LIST["bid_prices List Heap"]
                OB --> DEQUE_LIST[Deque Objects]
                
                BID_DICT --> PL1["PriceLevel at 50000"]
                BID_DICT --> PL2["PriceLevel at 49000"]
                
                PL1 --> DQ1["Deque Order1 Order2"]
                PL2 --> DQ2["Deque Order3"]
            </div>
        </div>

        <h2>7. Performance Characteristics</h2>
        <div class="complexity">
            <h3>Time Complexity</h3>
            <ul>
                <li><strong>Order Insertion</strong>: O(log n) - Heap insertion for price level</li>
                <li><strong>Order Matching</strong>: O(k log n) - k price levels, heap operations</li>
                <li><strong>FIFO Operations</strong>: O(1) - Deque popleft/append</li>
                <li><strong>Order Lookup</strong>: O(1) - Dictionary access</li>
            </ul>
            
            <h3>Space Complexity</h3>
            <ul>
                <li><strong>Per Order</strong>: O(1) - Constant space per order</li>
                <li><strong>Per Price Level</strong>: O(m) - m orders at that price</li>
                <li><strong>Total Order Book</strong>: O(n) - n total orders</li>
            </ul>
        </div>

        <h2>8. Real-time Data Flow</h2>
        <div class="diagram">
            <div class="mermaid">
            sequenceDiagram
                participant Trading
                participant Engine
                participant OrderBook
                participant WebSocket
                participant Clients
                
                Trading->>Engine: Submit Order
                Engine->>OrderBook: Process Order
                OrderBook->>OrderBook: Match/Fill
                OrderBook-->>Engine: Trades + Updates
                
                Engine->>Engine: Update Statistics
                Engine->>Engine: Register Callbacks
                
                Engine->>WebSocket: Trade Callback
                Engine->>WebSocket: Market Data Callback
                
                WebSocket->>Clients: Broadcast Trade
                WebSocket->>Clients: Broadcast BBO
            </div>
        </div>

        <div class="note">
            <strong>ðŸ“Œ Key Design Principles</strong>
            <ul>
                <li>Price-Time Priority: Best prices first, then FIFO</li>
                <li>No Trade-Throughs: Always match at best available price</li>
                <li>REG NMS Compliance: Internal order protection</li>
                <li>High Performance: O(log n) operations, optimized data structures</li>
                <li>Real-time Updates: WebSocket callbacks for live data</li>
            </ul>
        </div>

        <hr>
        <p style="text-align: center; color: #666;">
            Cryptocurrency Matching Engine - Built for GoQuant<br>
            Implementing REG NMS Principles with Price-Time Priority
        </p>
    </div>

    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
</body>
</html>
